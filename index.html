<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>STILLFLARE // Intelligence Suite v2.6</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
        :root {
            --brand-blue: #0061ff;
            --bg-light: #f4f7f9;
            --card-bg: #ffffff;
            --text-main: #1a1f36;
            --border-color: #d1d9e0;
        }

        body { background-color: var(--bg-light); color: var(--text-main); font-family: "Courier New", Courier, monospace; display: flex; justify-content: center; padding: 20px; margin: 0; }
        
        .dashboard-card { background: var(--card-bg); width: 100%; max-width: 700px; padding: 30px; border: 2px solid #000; position: relative; }

        /* BANNER AREA */
        .banner-container { width: 100%; margin-bottom: 20px; border-bottom: 3px double #000; padding-bottom: 10px; }
        .banner-container img { width: 100%; height: auto; display: block; }

        /* PDF OVERLAY */
        #pdfOverlay {
            display: none;
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255, 255, 255, 0.98);
            z-index: 100;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
        }

        .loader-bar-bg { width: 60%; height: 10px; background: #000; border: 1px solid #000; margin-top: 15px; }
        .loader-bar-fill { width: 0%; height: 100%; background: #fff; border-right: 2px solid #000; transition: width 0.4s ease; }

        /* DATA GRID */
        .pulse-grid { display: grid; grid-template-columns: 1fr 1fr; border: 1px solid #000; margin-bottom: 20px; }
        .pulse-stat { padding: 15px; border: 1px solid #000; text-align: center; }
        .stat-val { font-size: 32px; font-weight: bold; }
        .stat-label { font-size: 12px; text-transform: uppercase; font-weight: bold; }

        .chart-container { height: 250px; margin-bottom: 20px; border: 1px solid #000; padding: 10px; }

        /* HR REPORT STYLE LOGS */
        .report-section { border-top: 2px solid #000; padding-top: 15px; margin-top: 20px; }
        .report-item { display: flex; justify-content: space-between; padding: 5px 0; border-bottom: 1px dashed #ccc; font-size: 14px; }

        /* CONTROLS */
        .slider-container { margin-bottom: 15px; }
        input[type="range"] { width: 100%; cursor: pointer; }
        
        .btn-group { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 20px; }
        button { padding: 15px; font-family: "Courier New", Courier, monospace; font-weight: bold; cursor: pointer; border: 2px solid #000; background: #fff; }
        button:hover { background: #000; color: #fff; }
        
        #statusMsg { margin-top: 15px; font-size: 12px; text-align: center; font-weight: bold; }
    </style>
</head>
<body>

    <div class="dashboard-card" id="capture-area">
        <div id="pdfOverlay">
            <h2>GENERATING HR ARCHIVE</h2>
            <p id="loaderText">Compiling dot-matrix report...</p>
            <div class="loader-bar-bg"><div id="loaderFill" class="loader-bar-fill"></div></div>
        </div>

        <div class="banner-container">
            <img src="https://raw.githubusercontent.com/stillflareentertainment-web/stillflare-lab/main/STILLFLARE%20BANNER.png" alt="STILLFLARE LABS">
        </div>

        <div class="pulse-grid">
            <div class="pulse-stat">
                <div class="stat-label">GLOBAL_PULSE</div>
                <div id="globalPulse" class="stat-val">--%</div>
            </div>
            <div class="pulse-stat">
                <div class="stat-label">LOCAL_IDENTITY</div>
                <div id="personalPulse" class="stat-val">--%</div>
            </div>
        </div>

        <div class="chart-container"><canvas id="mainChart"></canvas></div>

        <div class="report-section">
            <div class="report-item"><span>[QS] QUALITY_OF_SERVICE</span><span id="qsVal">50%</span></div>
            <div class="slider-container"><input type="range" id="qs" min="0" max="100" value="50" oninput="updateVal('qs')"></div>
            
            <div class="report-item"><span>[OI] OPERATIONAL_INTEL</span><span id="oiVal">50%</span></div>
            <div class="slider-container"><input type="range" id="oi" min="0" max="100" value="50" oninput="updateVal('oi')"></div>
            
            <div class="report-item"><span>[IC] INTERNAL_CAPABILITY</span><span id="icVal">50%</span></div>
            <div class="slider-container"><input type="range" id="ic" min="0" max="100" value="50" oninput="updateVal('ic')"></div>
            
            <div class="report-item"><span>[EP] ENGINE_POWER</span><span id="epVal">50%</span></div>
            <div class="slider-container"><input type="range" id="ep" min="0" max="100" value="50" oninput="updateVal('ep')"></div>
        </div>

        <div class="btn-group">
            <button onclick="transmitData()">[ COMMIT_DATA ]</button>
            <button onclick="exportPDF()">[ EXPORT_REPORT ]</button>
        </div>
        
        <div id="statusMsg">TERMINAL READY // SYSTEM_OK</div>
        <div id="dateStamp" style="font-size: 10px; text-align: right; margin-top: 10px;"></div>
    </div>

    <script>
        const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRRO9rzX0DOaCBEppRFcRXtsIxxgK6fT6KIxAjFhq44PaoBEAtEy8fwjTEFNc9QZofF2P9srq0eYT4c/pub?gid=718698897&single=true&output=csv";
        let mainChart;

        function updateVal(id) { document.getElementById(id + 'Val').innerText = document.getElementById(id).value + '%'; }

        function initChart() {
            const ctx = document.getElementById('mainChart').getContext('2d');
            mainChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [], 
                    datasets: [
                        { label: 'GLOBAL', borderColor: '#000', data: [], tension: 0, borderWidth: 2, pointRadius: 0 },
                        { label: 'LOCAL', borderColor: '#000', borderDash: [5, 5], data: [], tension: 0, borderWidth: 2, pointRadius: 0 }
                    ]
                },
                options: { responsive: true, maintainAspectRatio: false, animation: false, plugins: { legend: { labels: { font: { family: 'Courier New' } } } } }
            });
        }

        async function syncData() {
            try {
                const response = await fetch(CSV_URL + "&cb=" + Date.now());
                const data = await response.text();
                const rows = data.split('\n').filter(r => r.trim() !== "").slice(1);
                let commData = []; let total = 0;
                rows.forEach(r => {
                    const c = r.split(',');
                    if(c.length >= 5) {
                        const avg = (parseInt(c[1]) + parseInt(c[2]) + parseInt(c[3]) + parseInt(c[4])) / 4;
                        commData.push(avg); total += avg;
                    }
                });
                document.getElementById('globalPulse').innerText = (rows.length > 0 ? Math.round(total / rows.length) : 0) + "%";
                const persData = JSON.parse(localStorage.getItem('stillflare_history') || "[]");
                if (persData.length > 0) document.getElementById('personalPulse').innerText = persData[persData.length - 1] + "%";
                mainChart.data.labels = Array.from({length: Math.max(rows.length, persData.length)}, (_, i) => i + 1);
                mainChart.data.datasets[0].data = commData;
                mainChart.data.datasets[1].data = persData;
                mainChart.update();
                document.getElementById('dateStamp').innerText = "REPORT_TS: " + new Date().toISOString();
            } catch (e) { console.error(e); }
        }

        async function transmitData() {
            const vals = [document.getElementById('qs').value, document.getElementById('oi').value, document.getElementById('ic').value, document.getElementById('ep').value];
            const avg = Math.round(vals.reduce((a,b) => parseInt(a)+parseInt(b)) / 4);
            let h = JSON.parse(localStorage.getItem('stillflare_history') || "[]");
            h.push(avg); localStorage.setItem('stillflare_history', JSON.stringify(h));
            const formID = "1FAIpQLSeqartuUmgNYc5RWaREX2yX0aGJU8_hWgAw8GKZiLK2QoXFpQ";
            const url = `https://docs.google.com/forms/d/e/${formID}/formResponse?entry.931849910=${vals[0]}&entry.1206314523=${vals[1]}&entry.1670010429=${vals[2]}&entry.152757542=${vals[3]}&submit=Submit`;
            document.getElementById('statusMsg').innerText = "TRANSMITTING TO CORE...";
            fetch(url, { mode: 'no-cors' }).then(() => {
                document.getElementById('statusMsg').innerText = "TRANSMISSION COMPLETE.";
                syncData();
            });
        }

        function exportPDF() {
            const overlay = document.getElementById('pdfOverlay');
            const fill = document.getElementById('loaderFill');
            const text = document.getElementById('loaderText');
            overlay.style.display = 'flex';
            fill.style.width = '10%';

            const element = document.getElementById('capture-area');
            const opt = { 
                margin: 0.1, 
                filename: 'MAAS_HR_REPORT.pdf', 
                html2canvas: { scale: 1.5, useCORS: true, onclone: (clonedDoc) => { clonedDoc.getElementById('pdfOverlay').style.display = 'none'; } }, 
                jsPDF: { unit: 'in', format: 'letter', orientation: 'portrait' } 
            };

            setTimeout(() => {
                fill.style.width = '50%';
                text.innerText = "STABILIZING SENSORS...";
                const worker = html2pdf().set(opt).from(element).toPdf();

                setTimeout(() => {
                    fill.style.width = '90%';
                    text.innerText = "FINALIZING ARCHIVE...";
                    worker.save().then(() => {
                        fill.style.width = '100%';
                        setTimeout(() => { overlay.style.display = 'none'; }, 1000);
                    });
                }, 4000); // 4 SECOND DELAY FOR STABILITY

            }, 500);
        }

        window.onload = () => { initChart(); syncData(); };
    </script>
</body>
</html>
