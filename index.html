<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>STILLFLARE // HR Terminal v2.7</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
        :root { --brand-blue: #000; --bg-light: #eef1f4; --text-main: #000; }
        body { background: var(--bg-light); color: #000; font-family: "Courier New", Courier, monospace; display: flex; justify-content: center; padding: 20px; }
        
        .dashboard-card { background: #fff; width: 100%; max-width: 750px; padding: 30px; border: 3px solid #000; position: relative; box-shadow: 10px 10px 0px #000; }

        /* BANNER */
        .banner-container { width: 100%; margin-bottom: 15px; border-bottom: 2px solid #000; }
        .banner-container img { width: 100%; height: auto; }

        /* OVERLAY */
        #pdfOverlay {
            display: none; position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: #fff; z-index: 100; flex-direction: column; align-items: center; justify-content: center;
        }
        .loader-bar { width: 70%; height: 20px; border: 2px solid #000; margin-top: 10px; position: relative; }
        .loader-fill { height: 100%; background: #000; width: 0%; transition: width 0.5s; }

        /* STATS */
        .pulse-box { display: flex; border: 2px solid #000; margin-bottom: 20px; }
        .stat { flex: 1; padding: 15px; border-right: 2px solid #000; text-align: center; }
        .stat:last-child { border-right: none; }
        .val { font-size: 28px; font-weight: bold; }
        .lab { font-size: 10px; text-decoration: underline; }

        /* CHART */
        .chart-wrap { height: 250px; border: 2px solid #000; padding: 10px; margin-bottom: 20px; background: #fff; }

        /* HR REPORT TEXT AREA */
        .hr-report { font-size: 13px; line-height: 1.2; border-top: 2px dashed #000; padding-top: 15px; }
        .row { display: flex; justify-content: space-between; margin-bottom: 8px; }

        /* BUTTONS */
        .controls { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 20px; }
        button { padding: 15px; font-family: "Courier New"; font-weight: bold; border: 2px solid #000; background: #fff; cursor: pointer; text-transform: uppercase; }
        button:hover { background: #000; color: #fff; }

        input[type="range"] { width: 100%; margin: 10px 0; accent-color: #000; }
        #statusMsg { font-size: 11px; text-align: center; margin-top: 10px; font-weight: bold; }
    </style>
</head>
<body>

    <div class="dashboard-card" id="capture-area">
        <div id="pdfOverlay">
            <h2 id="overlayTitle">INITIATING HR ARCHIVE...</h2>
            <div class="loader-bar"><div id="loaderFill" class="loader-fill"></div></div>
            <p id="loaderText" style="font-size: 12px; margin-top: 10px;">MOUNTING VIRTUAL DRIVE...</p>
        </div>

        <div class="banner-container">
            <img src="https://raw.githubusercontent.com/stillflareentertainment-web/stillflare-lab/main/STILLFLARE%20BANNER.png" alt="STILLFLARE">
        </div>

        <div class="pulse-box">
            <div class="stat"><div class="lab">GLOBAL_AVG</div><div id="globalPulse" class="val">--%</div></div>
            <div class="stat"><div class="lab">LOCAL_AVG</div><div id="personalPulse" class="val">--%</div></div>
            <div class="stat"><div class="lab">TREND_VECTOR</div><div id="trendVal" class="val">--</div></div>
        </div>

        <div class="chart-wrap"><canvas id="mainChart"></canvas></div>

        <div class="hr-report">
            <div style="font-weight: bold; margin-bottom: 10px;">[ OPERATIONAL TELEMETRY LOG ]</div>
            <div class="row"><span>QUAL_OF_SERVICE (QS):</span><span id="qsVal">50%</span></div>
            <input type="range" id="qs" min="0" max="100" value="50" oninput="updateVal('qs')">
            
            <div class="row"><span>OPER_INTEL (OI):</span><span id="oiVal">50%</span></div>
            <input type="range" id="oi" min="0" max="100" value="50" oninput="updateVal('oi')">
            
            <div class="row"><span>INTER_CAPACITY (IC):</span><span id="icVal">50%</span></div>
            <input type="range" id="ic" min="0" max="100" value="50" oninput="updateVal('ic')">
            
            <div class="row"><span>ENGINE_POWER (EP):</span><span id="epVal">50%</span></div>
            <input type="range" id="ep" min="0" max="100" value="50" oninput="updateVal('ep')">
        </div>

        <div class="controls">
            <button onclick="transmitData()">[ COMMIT_SYNC ]</button>
            <button onclick="exportPDF()">[ PRINT_REPORT ]</button>
        </div>
        
        <div id="statusMsg">STILLFLARE_OS: READY</div>
        <div id="dateStamp" style="font-size: 9px; margin-top: 15px; border-top: 1px solid #000; padding-top: 5px;"></div>
    </div>

    <script>
        const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRRO9rzX0DOaCBEppRFcRXtsIxxgK6fT6KIxAjFhq44PaoBEAtEy8fwjTEFNc9QZofF2P9srq0eYT4c/pub?gid=718698897&single=true&output=csv";
        let mainChart;

        function updateVal(id) { document.getElementById(id + 'Val').innerText = document.getElementById(id).value + '%'; }

        function initChart() {
            const ctx = document.getElementById('mainChart').getContext('2d');
            mainChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [], 
                    datasets: [
                        { label: 'GLOBAL', borderColor: '#000', data: [], tension: 0, borderWidth: 2, pointRadius: 0 },
                        { label: 'LOCAL', borderColor: '#000', borderDash: [5, 5], data: [], tension: 0, borderWidth: 2, pointRadius: 0 }
                    ]
                },
                options: { responsive: true, maintainAspectRatio: false, animation: false, scales: { y: { beginAtZero: true, max: 100 } } }
            });
        }

        async function syncData() {
            try {
                const response = await fetch(CSV_URL + "&cb=" + Date.now());
                const data = await response.text();
                const rows = data.split('\n').filter(r => r.trim() !== "").slice(1);
                let commData = []; let total = 0;
                rows.forEach(r => {
                    const c = r.split(',');
                    if(c.length >= 5) {
                        const avg = (parseInt(c[1]) + parseInt(c[2]) + parseInt(c[3]) + parseInt(c[4])) / 4;
                        commData.push(avg); total += avg;
                    }
                });
                const gAvg = (rows.length > 0 ? Math.round(total / rows.length) : 0);
                document.getElementById('globalPulse').innerText = gAvg + "%";
                
                const pData = JSON.parse(localStorage.getItem('stillflare_history') || "[]");
                if (pData.length > 0) {
                    const lAvg = pData[pData.length - 1];
                    document.getElementById('personalPulse').innerText = lAvg + "%";
                    // Trend logic
                    if(pData.length >= 2) {
                        const diff = lAvg - pData[pData.length - 2];
                        document.getElementById('trendVal').innerText = diff >= 0 ? "ASCEND" : "DESCEND";
                    }
                }
                
                mainChart.data.labels = Array.from({length: Math.max(rows.length, pData.length)}, (_, i) => i + 1);
                mainChart.data.datasets[0].data = commData;
                mainChart.data.datasets[1].data = pData;
                mainChart.update();
                document.getElementById('dateStamp').innerText = "SYSTEM_TIME: " + new Date().toLocaleString();
            } catch (e) { console.error(e); }
        }

        async function transmitData() {
            const v = [document.getElementById('qs').value, document.getElementById('oi').value, document.getElementById('ic').value, document.getElementById('ep').value];
            const avg = Math.round(v.reduce((a,b) => parseInt(a)+parseInt(b)) / 4);
            let h = JSON.parse(localStorage.getItem('stillflare_history') || "[]");
            h.push(avg); localStorage.setItem('stillflare_history', JSON.stringify(h));
            const fID = "1FAIpQLSeqartuUmgNYc5RWaREX2yX0aGJU8_hWgAw8GKZiLK2QoXFpQ";
            const url = `https://docs.google.com/forms/d/e/${fID}/formResponse?entry.931849910=${v[0]}&entry.1206314523=${v[1]}&entry.1670010429=${v[2]}&entry.152757542=${v[3]}&submit=Submit`;
            document.getElementById('statusMsg').innerText = "PUSHING TELEMETRY...";
            fetch(url, { mode: 'no-cors' }).then(() => {
                document.getElementById('statusMsg').innerText = "SYNC SUCCESS.";
                syncData();
            });
        }

        function exportPDF() {
            const overlay = document.getElementById('pdfOverlay');
            const fill = document.getElementById('loaderFill');
            const text = document.getElementById('loaderText');
            overlay.style.display = 'flex';
            
            // Progress sequencing
            let progress = 0;
            const interval = setInterval(() => {
                progress += 5;
                fill.style.width = progress + "%";
                if(progress === 20) text.innerText = "BUFFERING ASSETS...";
                if(progress === 50) text.innerText = "CALCULATING VECTORS...";
                if(progress === 80) text.innerText = "CAPTURING HR LOG...";
                if(progress >= 100) clearInterval(interval);
            }, 300);

            const opt = { 
                margin: 0.1, 
                filename: 'SF_HR_ARCHIVE.pdf', 
                html2canvas: { scale: 1.5, useCORS: true, onclone: (cloned) => {
                    cloned.getElementById('pdfOverlay').style.display = 'none';
                    // Hide the interactive buttons in the PDF
                    cloned.querySelector('.controls').style.display = 'none';
                }}, 
                jsPDF: { unit: 'in', format: 'letter', orientation: 'portrait' } 
            };

            // THE 6-SECOND HOLD
            setTimeout(() => {
                html2pdf().set(opt).from(document.getElementById('capture-area')).save().then(() => {
                    overlay.style.display = 'none';
                    fill.style.width = '0%';
                });
            }, 6000);
        }

        window.onload = () => { initChart(); syncData(); };
    </script>
</body>
</html>
