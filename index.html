<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>STILLFLARE // HR ARCHIVE v2.8</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
        body { background: #d3d3d3; color: #000; font-family: "Courier New", Courier, monospace; display: flex; justify-content: center; padding: 20px; }
        
        .terminal-card { 
            background: #fff; width: 100%; max-width: 800px; padding: 40px; 
            border: 2px solid #000; position: relative;
            box-shadow: 8px 8px 0px #000;
        }

        .hr-header { border-bottom: 2px solid #000; padding-bottom: 10px; margin-bottom: 20px; text-align: center; }
        .hr-header img { width: 100%; max-height: 120px; object-fit: contain; }

        #pdfOverlay {
            display: none; position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: #fff; z-index: 100; flex-direction: column; align-items: center; justify-content: center;
        }

        .pulse-table { width: 100%; border-collapse: collapse; margin-bottom: 20px; }
        .pulse-table td { border: 1px solid #000; padding: 10px; text-align: center; width: 33.3%; }
        .label { font-size: 10px; font-weight: bold; text-decoration: underline; margin-bottom: 5px; display: block; }
        .value { font-size: 24px; font-weight: bold; }

        .chart-frame { border: 1px solid #000; height: 250px; padding: 10px; margin-bottom: 20px; }

        .form-section { border-top: 1px dashed #000; padding-top: 20px; }
        .slider-row { display: flex; align-items: center; margin-bottom: 15px; }
        .slider-label { flex: 2; font-size: 13px; font-weight: bold; }
        .slider-input { flex: 3; }
        .slider-val { flex: 1; text-align: right; font-weight: bold; }

        .terminal-ops { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 30px; }
        button { 
            background: #fff; color: #000; border: 2px solid #000; 
            padding: 15px; font-family: "Courier New"; font-weight: bold; 
            cursor: pointer; text-transform: uppercase;
        }
        button:hover { background: #000; color: #fff; }

        .intro-text { font-size: 12px; margin-bottom: 20px; line-height: 1.4; border: 1px solid #000; padding: 15px; background: #f9f9f9; }
        
        #statusLine { font-size: 11px; margin-top: 20px; border-top: 1px solid #000; padding-top: 10px; }
    </style>
</head>
<body>

<div class="terminal-card" id="capture-area">
    <div id="pdfOverlay">
        <h2 style="border: 2px solid #000; padding: 10px;">ARCHIVING TO DISK...</h2>
        <p style="margin-top: 20px;">PLEASE STAND BY (8 SECONDS)</p>
    </div>

    <div class="hr-header">
        <img src="https://raw.githubusercontent.com/stillflareentertainment-web/stillflare-lab/main/STILLFLARE%20BANNER.png" alt="STILLFLARE BANNER">
    </div>

    <div class="intro-text">
        [ SYSTEM OVERVIEW ]: Intelligence Suite v2.8 // SECURE HR TERMINAL<br>
        [ PURPOSE ]: To ingest local performance telemetry and cross-reference with Global Pulse vectors.<br>
        [ INSTRUCTION ]: Adjust sliders to current state -> COMMIT -> PRINT ARCHIVE.<br>
        [ FUTURE_STATE ]: Deployment of community benchmarks and collaborative real-time goals.
    </div>

    <table class="pulse-table">
        <tr>
            <td><span class="label">GLOBAL_PULSE</span><div id="globalPulse" class="value">--%</div></td>
            <td><span class="label">LOCAL_IDENTITY</span><div id="personalPulse" class="value">--%</div></td>
            <td><span class="label">TREND_VECTOR</span><div id="trendVal" class="value">--</div></td>
        </tr>
    </table>

    <div class="chart-frame"><canvas id="mainChart"></canvas></div>

    <div class="form-section">
        <div class="slider-row">
            <div class="slider-label">QUAL_OF_SERVICE (QS)</div>
            <input type="range" id="qs" class="slider-input" min="0" max="100" value="50" oninput="updateVal('qs')">
            <div id="qsVal" class="slider-val">50%</div>
        </div>
        <div class="slider-row">
            <div class="slider-label">OPER_INTEL (OI)</div>
            <input type="range" id="oi" class="slider-input" min="0" max="100" value="50" oninput="updateVal('oi')">
            <div id="oiVal" class="slider-val">50%</div>
        </div>
        <div class="slider-row">
            <div class="slider-label">INTER_CAPACITY (IC)</div>
            <input type="range" id="ic" class="slider-input" min="0" max="100" value="50" oninput="updateVal('ic')">
            <div id="icVal" class="slider-val">50%</div>
        </div>
        <div class="slider-row">
            <div class="slider-label">ENGINE_POWER (EP)</div>
            <input type="range" id="ep" class="slider-input" min="0" max="100" value="50" oninput="updateVal('ep')">
            <div id="epVal" class="slider-val">50%</div>
        </div>
    </div>

    <div class="terminal-ops">
        <button onclick="transmitData()">[ COMMIT_SYNC ]</button>
        <button onclick="exportPDF()">[ PRINT_REPORT ]</button>
    </div>

    <div id="statusLine">STATUS: TERMINAL_READY // SYNC_ON // TIME: <span id="ts"></span></div>
</div>

<script>
    const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRRO9rzX0DOaCBEppRFcRXtsIxxgK6fT6KIxAjFhq44PaoBEAtEy8fwjTEFNc9QZofF2P9srq0eYT4c/pub?gid=718698897&single=true&output=csv";
    let mainChart;

    function updateVal(id) { document.getElementById(id + 'Val').innerText = document.getElementById(id).value + '%'; }

    function initChart() {
        const ctx = document.getElementById('mainChart').getContext('2d');
        mainChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: [], 
                datasets: [
                    { label: 'GLOBAL', borderColor: '#000', data: [], tension: 0, borderWidth: 2, pointRadius: 0 },
                    { label: 'LOCAL', borderColor: '#000', borderDash: [5, 5], data: [], tension: 0, borderWidth: 2, pointRadius: 0 }
                ]
            },
            options: { responsive: true, maintainAspectRatio: false, animation: false, scales: { y: { beginAtZero: true, max: 100 } } }
        });
    }

    async function syncData() {
        try {
            const response = await fetch(CSV_URL + "&cb=" + Date.now());
            const data = await response.text();
            const rows = data.split('\n').filter(r => r.trim() !== "").slice(1);
            let commData = []; let total = 0;
            rows.forEach(r => {
                const c = r.split(',');
                if(c.length >= 5) {
                    const avg = (parseInt(c[1]) + parseInt(c[2]) + parseInt(c[3]) + parseInt(c[4])) / 4;
                    commData.push(avg); total += avg;
                }
            });
            document.getElementById('globalPulse').innerText = (rows.length > 0 ? Math.round(total / rows.length) : 0) + "%";
            
            const pData = JSON.parse(localStorage.getItem('stillflare_history') || "[]");
            if (pData.length > 0) {
                document.getElementById('personalPulse').innerText = pData[pData.length - 1] + "%";
                if(pData.length >= 2) {
                    const diff = pData[pData.length - 1] - pData[pData.length - 2];
                    document.getElementById('trendVal').innerText = diff >= 0 ? "ASCEND" : "DESCEND";
                }
            }
            mainChart.data.labels = Array.from({length: Math.max(rows.length, pData.length)}, (_, i) => i + 1);
            mainChart.data.datasets[0].data = commData;
            mainChart.data.datasets[1].data = pData;
            mainChart.update();
            document.getElementById('ts').innerText = new Date().toLocaleString();
        } catch (e) { console.error(e); }
    }

    async function transmitData() {
        const v = [document.getElementById('qs').value, document.getElementById('oi').value, document.getElementById('ic').value, document.getElementById('ep').value];
        const avg = Math.round(v.reduce((a,b) => parseInt(a)+parseInt(b)) / 4);
        let h = JSON.parse(localStorage.getItem('stillflare_history') || "[]");
        h.push(avg); localStorage.setItem('stillflare_history', JSON.stringify(h));
        const fID = "1FAIpQLSeqartuUmgNYc5RWaREX2yX0aGJU8_hWgAw8GKZiLK2QoXFpQ";
        const url = `https://docs.google.com/forms/d/e/${fID}/formResponse?entry.931849910=${v[0]}&entry.1206314523=${v[1]}&entry.1670010429=${v[2]}&entry.152757542=${v[3]}&submit=Submit`;
        document.getElementById('statusLine').innerText = "TRANSMITTING TELEMETRY...";
        fetch(url, { mode: 'no-cors' }).then(() => {
            document.getElementById('statusLine').innerText = "STATUS: SYNC_COMPLETE";
            syncData();
        });
    }

    function exportPDF() {
        const overlay = document.getElementById('pdfOverlay');
        overlay.style.display = 'flex';

        const opt = { 
            margin: 0, 
            filename: 'SF_ARCHIVE_LOG.pdf', 
            html2canvas: { scale: 2, useCORS: true, onclone: (cloned) => {
                cloned.getElementById('pdfOverlay').style.display = 'none';
            }}, 
            jsPDF: { unit: 'in', format: 'letter', orientation: 'portrait' } 
        };

        // 8 SECOND HOLD for ultra-stability and image rendering
        setTimeout(() => {
            html2pdf().set(opt).from(document.getElementById('capture-area')).save().then(() => {
                overlay.style.display = 'none';
            });
        }, 8000);
    }

    window.onload = () => { initChart(); syncData(); };
</script>

</body>
</html>
