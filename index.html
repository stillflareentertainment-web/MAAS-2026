import json
import os
import glob

def calculate_daily_pulse():
    # 1. Collect all anonymous submissions from the /submissions folder
    submission_files = glob.glob("submissions/*.json")
    
    if not submission_files:
        return # No new data to process
    
    total_metrics = {'qs': 0, 'oi': 0, 'ic': 0, 'di': 0, 'ep': 0}
    count = len(submission_files)

    for file in submission_files:
        with open(file, 'r') as f:
            data = json.load(f)
            for key in total_metrics:
                total_metrics[key] += data.get(key, 50)

    # 2. Calculate the "Community Mean"
    avg_metrics = {k: v / count for k, v in total_metrics.items()}
    
    # 3. Update the Keeper Model file
    with open("community_pulse.json", "w") as f:
        json.dump({
            "last_update": "2026-02-16",
            "averages": avg_metrics,
            "sample_size": count,
            "status": "OS_UPGRADED"
        }, f)

    # 4. Clear the folder for the next day's cycle
    for file in submission_files:
        os.remove(file)

if __name__ == "__main__":
    calculate_daily_pulse() 
